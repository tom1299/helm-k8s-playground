# Process trivy scan results in GitLab
## Basic idea
* Scan a docker image with the trivy-operator
* Use the gitlab format for the report
* Upload the report to the gitlab package registry
* Upload triggers a pipeline to process the report, e.g adds the file to the vulnerability dashboard:
```yaml
  artifacts:
    when:                          always
    reports:
      container_scanning:          gl-container-scanning-report.json
```
See here: https://trivy.dev/v0.18.3/integrations/gitlab-ci/


## Upload a file to a package registry
The token used is a deploy token for the project:
```shell
curl --request PUT \
  --user "gitlab+deploy-token-xxx:gldt-xxx" \
  --header "Content-Type: multipart/form-data" \
  --form "file=@Dockerfile" \
  "https://gitlab.com/api/v4/projects/325747/packages/generic/test-report-1/1.0.0/Dockerfile"
```

## Using the gitlab template for the trivy-operator
See [here](https://trivy.dev/v0.29.2/docs/integrations/gitlab-ci/)
```shell
--format template --template "@/contrib/gitlab.tpl
```
The tpl can be found [here](https://github.com/aquasecurity/trivy/blob/main/contrib/gitlab.tpl)

## Converting
Use `trivy convert` to convert the report in conjunction with `--template "@/contrib/gitlab.tpl`

```shell
trivy convert --debug --format template --template "@./contrib/gitlab.tpl" --output trivy-operator-sample-report-gitlab.json  trivy-operator-sample-report.json
```
```
trivy convert --debug --format table --output trivy-operator-sample-report-gitlab.txt  trivy-operator-sample-report.json
```


## Trivy-connector
### Abstract
The trivy-connector is a small web server that exposes an api for receiving trivy vulnerability reports and can forward them to other endpoints such as GitLab. Here is a description of the service:
* The service listens on port 8080

### API
* The service accepts POST requests on the `/v1/report` endpoint
* The endpoint should only accept json payloads and support `POST` requests

### The context
* The context should be a simple map-style object from which processors can get specific configuration items
* The access should be done via a key-value store
* The context should be filled by adding all environment variables that start with `TRIVY_CONNECTOR_` to the context

### Processor interface
* The processor interface defines the function that processes the report
* The interface should have the following parameters:
  * The report as json
  * The context (see above)

### The gitlab processor
The gitlab processor should be able to upload the report to the gitlab package registry using the api like in this curl sample:
```shell
curl -vvv --request PUT --header "PRIVATE-TOKEN: XXX"   --header "Content-Type: multipart/form-data"   --form "file=@trivy-operator-sample-report.json"   "https://gitlab.com/api/v4/projects/325747/packages/generic/trivy-vulnerability-report/1.0.0/Dockerfile"
```
The url up to `generic` should be configurable via the context.
The version number should be generated by concatenating the `1.0.0` with six digits from the sha of the report like this: `1.0.0-`sha[:6]`
Additional headers should be available from the context using the key `TRIVY_CONNECTOR_GITLAB_HEADERS` which should be a string. Headers should be separated by `,`. The headers should be added to the request.

### The connector logic itself
* After receiving a report, should call the processor with the report and the context
* For the time being the connector should only support the gitlab processor